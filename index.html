<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>clock</title>
  <style>
    html, body {
      background-color: #eee;
      font-size: 12px;
    }

    .clock-box {
      padding: 5px 10px;
    }

    .btn {
      display: inline-block;
      font-size: 45px;
      border: 2px solid;
      border-radius: 8px;
      -webkit-user-select: none;
      transition: all 0.2s ease-in-out;
    }

    .btn:hover,
    .btn:active,
    .btn:focus {
      outline: 0;
      cursor: pointer;
      text-decoration: none;
    }

    .btn:hover,
    .btn:active {
      -webkit-box-shadow: 0 0px 5px rgba(0, 0, 0, 0.12),
      0 5px 5px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      -webkit-box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19),
      0 6px 6px rgba(0, 0, 0, 0.23);
    }

    .btn:disabled {
      cursor: not-allowed !important;
      pointer-events: none;
      /*opacity: 0.6;*/
      box-shadow: none;
    }

    .box-context {
      display: inline-block;
      line-height: 20px;
      padding: 5px 0px;
      margin: 0 10px;
    }

    .progressbar {
      width: 180px;
      height: 6px;
      border-radius: 5px;
      background-color: #fff;
    }

    .warning-time {
      color: #aaa;
    }

    .time {
      font-size: 15px;
    }

    .default {
      background-color: #eee;
      color: #fff;
    }

    .success {
      background-color: #6495ed;
      color: #fff;
    }

    .warning {
      color: #ec971f;
    }

    .danger {
      color: #d9534f;
    }

    .close {
      position: absolute;
      font-size: 20px;
      background-color: #a9a9a9;
      width: 265px;
    }

    .auto-clockin-time, .auto-clockout-time {
      display: inline-block;
      width: 113px;
      border: none;
      background-color: #eee;
      color: #aaa;
    }

    .auto-clockout-time:hover, .auto-clockin-time:hover,
    .auto-clockout-time:active, .auto-clockin-time:active,
    .auto-clockout-time:focus, .auto-clockin-time:focus {
      outline: 0;
      text-decoration: none;
      border-bottom: 1px solid;
    }
  </style>
</head>

<body>
<!--   <div class="date">
    <h2>2016.07.23(六)</h2>
  </div> -->

  <div class="clock-box">
    <button class="btn clockin-btn default">上</button>
    <div class="box-context">
      <div>
        <span>打卡时间：</span>
        <!-- <span>未打卡</span> -->
        <span class="time warning clockin-time">未打卡</span>
      </div>
      <div class="progressbar clockin-pb"></div>
      <div class="warning-time">
        <span>自动打卡：</span>
        <input class="auto-clockin-time" value="08:58:00"></input>
      </div>
    </div>

  </div>
  <hr>
  <div class="clock-box">
    <button class="btn clockout-btn default">下</button>
    <div class="box-context">
      <div>
        <span>打卡时间：</span>
        <span class="time warning clockout-time">未打卡</span>
        <!-- <span class="time">08:48:12</span> -->
      </div>
      <div class="progressbar clockout-pb"></div>
      <div class="warning-time">
        <span>自动打卡：</span>
        <input class="auto-clockout-time" value="18:02:00"></input>
      </div>
    </div>
  </div>
  <hr>
  <div class="clock-box">
    <button class="btn default close">退</button>
  </div>
</body>

<script src="./libs/jquery-1.9.1.min.js"></script>

<script>
  const CronJob = require('cron').CronJob;
  const CronTime = require('cron').CronTime;
  const check = require('./clock/src/checkStatus.js');
  const reg = require('./clock/src/index.js');
  const timeCheck = require('./clock/src/timeCheck.js');
  const moment = require('moment');

  const registered = (name, time) => {
    $(`.${name}-btn`)
      .addClass('success')
      .attr('disabled', 'true');

    $(`.${name}-pb`).addClass('success');

    $(`.${name}-time`)
      .removeClass('warning')
      .text(time);
  }

  const reset = (name) => {
    $(`.${name}-btn`)
      .removeClass('success')
      .attr('disabled', false);

    $(`.${name}-pb`).removeClass('success');

    $(`.${name}-time`)
      .addClass('warning')
      .text('未打卡');
  }

  const checkThenRest = () => {
    check().then((status) => {
      status = status || {};
      if(status.clockinTime) {
        registered('clockin', status.clockinTime);
      } else {
        reset('clockin');
      }

      if(status.clockoutTime) {
        registered('clockout', status.clockinTime);
      } else {
        reset('clockout');
      }

    }).catch(console.log.bind(console));
  }

  const checkThenReg = (name) => {
    check().then((status) => {
      status = status || {};
      if (name === 'clockin') {
        if(status.clockinTime) {
          registered(name, status.clockinTime);
        } else {
          reg('on').then(() => {
            checkThenReg(name);
          });
        }
      }

      if (name === 'clockout') {
        if(status.clockoutTime) {
          registered(name, status.clockoutTime);
        } else {
          reg('off').then(() => {
            checkThenReg(name);
          });
        }
      }

    }).catch(console.log.bind(console));
  }

  const converTime = (time) => {
    const cvt = moment(time, "hh:mm:ss");
    const viewTime = cvt.format("HH:mm:ss");
    const cronTime = cvt.format("ss mm HH");
    return {
      viewTime: viewTime,
      cronTime: cronTime
    }
  }

  const jobClockin = new CronJob('00 55 08 * * 1-5', function() {
    checkThenReg('clockin');
  }, null, true, 'Asia/Shanghai');

  const jobClockout = new CronJob('00 02 18 * * 1-5', function() {
    checkThenReg('clockout');
  }, null, true, 'Asia/Shanghai');

  new CronJob('00 01 00 * * 1-5', function() {
    reset('clockin');
    reset('clockout');
  }, null, true, 'Asia/Shanghai');

  $(document).ready(function() {

    var DEFAULT_CLOCKIN_TIME = '08:55:00';
    var DEFAULT_CLOCKOUT_TIME = '18:02:00';

    var autoClockin = $('.auto-clockin-time');
    var autoClockout = $('.auto-clockout-time');

    // try {
    //   var autoClockinTime = localStorage.getItem('auto-clockin-time');
    //   var autoClockoutTime = localStorage.getItem('auto-clockout-time');

    //   if(!autoClockinTime) {
    //     localStorage.setItem('auto-clockin-time', DEFAULT_CLOCKIN_TIME);
    //     autoClockin.val(DEFAULT_CLOCKIN_TIME);
    //   } else {
    //     autoClockin.val(autoClockinTime);
    //   }
    //   if(!autoClockoutTime) {
    //     localStorage.setItem('auto-clockout-time', DEFAULT_CLOCKOUT_TIME);
    //     autoClockout.val(DEFAULT_CLOCKOUT_TIME);
    //   } else {
    //     autoClockout.val(autoClockoutTime);
    //   }
    // } catch(e) {
    //   alert(e);
    // }

    checkThenRest();

    $('.clockin-btn').on('click', function(e) {
      checkThenReg('clockin');
    });

    $('.clockout-btn').on('click', function(e) {
      checkThenReg('clockout');
    });

    $('.close').on('click', function(e) {
      window.close();
    });

    autoClockin.on('blur', function(e) {
      const time = converTime(autoClockin.val());
      // localStorage.setItem('auto-clockin-time', time.viewTime);
      jobClockin.setTime(new CronTime(`${time.cronTime} * * 1-5`));
      jobClockin.start();
    });

    autoClockout.on('blur', function(e) {
      const time = converTime(autoClockout.val());
      // localStorage.setItem('auto-clockout-time', time.viewTime);
      jobClockout.setTime(new CronTime(`${time.cronTime} * * 1-5`));
      jobClockout.start();
    });
  })
</script>
</html>
